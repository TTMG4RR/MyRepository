<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 命名空间：必须等于ProductMapper接口的全类名（绑定接口） -->
<mapper namespace="com.drawbluecup.mapper.ProductMapper">
<!--
    结果映射:商品及其订单列表
    使用<collection>标签处理一对多关系(一个商品对应有多个订单)
-->
    <resultMap id="ProductWithOrdersResultMap" type="com.drawbluecup.entity.Product">
        <!-- 商品表字段 -->
        <id column="p_id" property="id"/>
        <result column="p_name" property="name"/>
        <result column="price" property="price"/>

        <!-- 关联的订单列表（多对多） -->
        <collection property="orders" ofType="com.drawbluecup.entity.Order">
            <id column="order_id" property="id"/>
            <result column="order_no" property="orderNo"/>
            <result column="user_id" property="userId"/>
            <result column="create_time" property="createTime"/>
        </collection>
    </resultMap>


    <select
            id="findAll"
            resultType="com.drawbluecup.entity.Product"
    >
        <!--查询所有商品信息-->
        SELECT * FROM product

    </select>


    <select
            id="findById"
            resultType="com.drawbluecup.entity.Product"
            parameterType="java.lang.Integer"
    >
        <!--根据id查询商品-->
        SELECT id, name FROM product where id = #{id}
    </select>


    <select
            id="findByName"
            resultType="com.drawbluecup.entity.Product"
            parameterType="java.lang.String"
    >
        <!--根据name查询商品(支持模糊)-->
        SELECT id, name FROM product where name LIKE CONCAT('%', #{name}, '%')
    </select>




    <insert
            id="add"
            parameterType="com.drawbluecup.entity.Product"
    >
        <!--新增商品-->
        INSERT INTO product (name) values (#{name})
    </insert>


    <delete
            id="deleteById"
            parameterType="java.lang.Integer"
    >
        <!--根据id删除商品-->
        delete from product where id = #{id}
    </delete>

    <delete
            id="deleteAll"
    >
        <!--删除所有商品,但首先要先删除关联表(例如订单表)-->
        delete from product
    </delete>




    <update
            id="update"
            parameterType="com.drawbluecup.entity.Product"
    >
        <!--更新商品(本质基于查询)-->
        update product set name=#{name}  where id = #{id}
    </update>



    <!--
        查询订单及其关联的商品列表（多对多 JOIN 查询）
    -->
    <select id="findProductWithOrders" resultMap="ProductWithOrdersResultMap">
        SELECT
        p.id AS p_id,
        p.name AS p_name,
        o.id AS order_id,
        o.order_no,
        o.user_id,
        o.create_time
        FROM product p
        LEFT JOIN order_product op ON p.id = op.product_id
        LEFT JOIN `order` o ON op.order_id = o.id
        WHERE p.id = #{productId}
        ORDER BY p.id, o.id
    </select>





</mapper>


